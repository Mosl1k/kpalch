{% extends "base.html" %}

{% block title %}–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ - –ù–µ–∑–∞–±—É–¥–∫–∏{% endblock title %}

{% block content %}{% load static %}
    <div class="container">
    <nav class="category-nav">
        <!-- –ü–ª—é—Å–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ -->
        <button class="add-category-btn" onclick="toggleAddCategory()" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫">
            <span class="plus-icon">+</span>
        </button>
        <div class="add-category-form" id="addCategoryForm" style="display: none;">
            <input type="text" 
                   id="newCategoryName" 
                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞"
                   onkeypress="if(event.key === 'Enter') addNewCategory()">
            <button class="btn btn-primary" onclick="addNewCategory()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        {% for item in categories_with_deletable %}
        <div class="category-item-wrapper">
            <a href="/?category={{ item.category.name }}" 
               class="category-link {% if current_category == item.category.name %}active{% endif %}">
                {{ item.category.display_name }}
            </a>
            {% if item.can_delete %}
            <button class="delete-category-btn" 
                    onclick="deleteCategory('{{ item.category.name|escapejs }}', '{{ item.category.display_name|escapejs }}')" 
                    title="–£–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫">
                √ó
            </button>
            {% endif %}
        </div>
        {% endfor %}
    </nav>

    <div id="shoppingListContainer">
        {% if items %}
        <ul class="shopping-list" id="shoppingList">
            {% for item in items %}
            <li class="shopping-item priority-{% if item.priority == 3 %}high{% elif item.priority == 2 %}medium{% else %}low{% endif %} {% if item.bought %}bought{% endif %}" 
                data-name="{{ item.name }}" 
                data-category="{{ item.category.name }}"
                data-priority="{{ item.priority }}">
                <div class="item-name">
                    <span class="priority-icon">
                        {% if item.priority == 3 %}üî•
                        {% elif item.priority == 2 %}üü°
                        {% else %}üü¢
                        {% endif %}
                    </span>
                    <span>{{ item.name }}</span>
                </div>
                <div class="item-actions">
                    <input type="checkbox" 
                           class="checkbox item-checkbox" 
                           {% if item.bought %}checked{% endif %}
                           onchange="handleCheckboxChange('{{ item.name|escapejs }}', this);"
                           data-item-name="{{ item.name }}">
                    {% if item.bought %}
                    <button class="btn btn-small btn-move move-up-btn" 
                            onclick="moveItem('{{ item.name|escapejs }}', 'up')"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                        ‚Üë
                    </button>
                    <button class="btn btn-small btn-move move-down-btn" 
                            onclick="moveItem('{{ item.name|escapejs }}', 'down')"
                            title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                        ‚Üì
                    </button>
                    {% endif %}
                    <button class="btn btn-small btn-danger delete-btn" 
                            onclick="deleteItem('{{ item.name|escapejs }}')"
                            style="display: {% if item.bought %}inline-block{% else %}none{% endif %};">
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç!</p>
        </div>
        {% endif %}
        </div>
        
    <!-- –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ" –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
    <div class="bulk-delete-container" id="bulkDeleteContainer" style="display: none;">
        <div class="bulk-delete-info">
            <span id="selectedCount">0</span> —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—ã–±—Ä–∞–Ω–æ
        </div>
        <button class="btn btn-danger bulk-delete-btn" onclick="deleteSelectedItems()">
            –£–¥–∞–ª–∏—Ç—å –≤—Å–µ
        </button>
    </div>
        
        <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ -->
        <div class="edit-form" id="editForm" style="display: none;">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç</h3>
            <div class="form-group">
                <input type="text" 
                       id="editItemName" 
                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞"
                       onkeypress="if(event.key === 'Enter') saveEditItem(); if(event.key === 'Escape') cancelEdit();">
                <select id="editItemCategory">
                    {% for category in categories %}
                    <option value="{{ category.name }}">
                        {{ category.display_name }}
                    </option>
                    {% endfor %}
                </select>
                <select id="editItemPriority">
                    <option value="1">–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="2" selected>–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                    <option value="3">–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                </select>
                <button class="btn btn-primary" onclick="saveEditItem()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button>
            </div>
    </div>
        
        <div class="add-form">
            <h3>–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</h3>
        <div class="form-group">
            <input type="text" 
                   id="itemName" 
                   placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞"
                   onkeypress="if(event.key === 'Enter') addItem()">
            <select id="itemCategory">
                {% for category in categories %}
                <option value="{{ category.name }}" {% if current_category == category.name %}selected{% endif %}>
                    {{ category.display_name }}
                </option>
                {% endfor %}
            </select>
            <select id="itemPriority">
                <option value="1">–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                <option value="2" selected>–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
                <option value="3">–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</option>
            </select>
            <button class="btn btn-primary" onclick="addItem()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* –ü–ª—é—Å–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    .category-nav {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .add-category-btn {
        width: auto;
        min-width: 50px;
        height: auto;
        min-height: 50px;
        padding: 0.75rem 1.5rem;
        border-radius: 5px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-size: 1.8rem;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 0.5rem;
        vertical-align: middle;
        line-height: 1;
    }
    .add-category-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
    }
    .add-category-form {
        position: absolute;
        top: 60px;
        left: 0;
        background: white;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        gap: 0.5rem;
        align-items: center;
        z-index: 10;
        min-width: 300px;
    }
    .add-category-form input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }
    /* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */
    .delete-category-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #ff4444;
        color: white;
        border: 2px solid white;
        font-size: 1.2rem;
        font-weight: bold;
        line-height: 1;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.2s;
        z-index: 5;
    }
    .delete-category-btn:hover {
        background: #cc0000;
        transform: scale(1.2);
    }
    
    /* –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ" */
    .bulk-delete-container {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 1rem 2rem;
        border-radius: 50px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 1.5rem;
        z-index: 1000;
        animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }
    .bulk-delete-info {
        font-weight: 500;
        color: #333;
    }
    .bulk-delete-btn {
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
    }
</style>
{% endblock extra_css %}

{% block extra_js %}
{% csrf_token %}
    <script>
    const currentCategory = '{% if current_category %}{{ current_category }}{% else %}–∫—É–ø–∏—Ç—å{% endif %}';
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    let editingItemName = null;
    let editingItemCategory = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    function addMoveButtons(itemElement) {
        const itemName = itemElement.getAttribute('data-name');
        const actionsDiv = itemElement.querySelector('.item-actions');
        const deleteBtn = itemElement.querySelector('.delete-btn');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ –∫–Ω–æ–ø–æ–∫
        if (actionsDiv.querySelector('.move-up-btn')) {
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        const moveUpBtn = document.createElement('button');
        moveUpBtn.className = 'btn btn-small btn-move move-up-btn';
        moveUpBtn.textContent = '‚Üë';
        moveUpBtn.title = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö';
        moveUpBtn.onclick = () => moveItem(itemName, 'up');
        
        const moveDownBtn = document.createElement('button');
        moveDownBtn.className = 'btn btn-small btn-move move-down-btn';
        moveDownBtn.textContent = '‚Üì';
        moveDownBtn.title = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑';
        moveDownBtn.onclick = () => moveItem(itemName, 'down');
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π —É–¥–∞–ª–µ–Ω–∏—è
        actionsDiv.insertBefore(moveDownBtn, deleteBtn);
        actionsDiv.insertBefore(moveUpBtn, moveDownBtn);
    }
    
    function getCSRFToken() {
        // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ input
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            return csrfInput.value;
        }
        // –ï—Å–ª–∏ –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }
    
    async function addItem() {
        const name = document.getElementById('itemName').value.trim();
        const category = document.getElementById('itemCategory').value;
        const priority = parseInt(document.getElementById('itemPriority').value);
        
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞');
            return;
        }
        
        try {
            const response = await fetch('/api/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                credentials: 'include',
                body: JSON.stringify({name, category, priority})
            });
            
            if (response.ok) {
                document.getElementById('itemName').value = '';
                window.location.reload();
            } else {
                const data = await response.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–±–æ–∫—Å–∞
    function handleCheckboxChange(name, checkbox) {
        const bought = checkbox.checked;
        // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
        updateSelectionCount();
        toggleBought(name, bought, checkbox);
    }
    
    async function toggleBought(name, bought, checkbox) {
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω');
            console.error('CSRF token not found');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–∏—Ç—å –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Å—Ä–∞–∑—É –¥–ª—è –ª—É—á—à–µ–≥–æ UX
        const itemElement = checkbox.closest('.shopping-item');
        const deleteBtn = itemElement.querySelector('.delete-btn');
        const moveUpBtn = itemElement.querySelector('.move-up-btn');
        const moveDownBtn = itemElement.querySelector('.move-down-btn');
        
        if (bought) {
            deleteBtn.style.display = 'inline-block';
            itemElement.classList.add('bought');
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è, –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
            if (!moveUpBtn || !moveDownBtn) {
                addMoveButtons(itemElement);
            } else {
                moveUpBtn.style.display = 'inline-block';
                moveDownBtn.style.display = 'inline-block';
            }
        } else {
            deleteBtn.style.display = 'none';
            itemElement.classList.remove('bought');
            if (moveUpBtn) moveUpBtn.style.display = 'none';
            if (moveDownBtn) moveDownBtn.style.display = 'none';
        }
        
        try {
            const response = await fetch(`/api/buy/${encodeURIComponent(name)}?category=${encodeURIComponent(currentCategory)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'include',
                body: JSON.stringify({bought})
            });
            
            if (response.ok) {
                // –ù–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                setTimeout(function() {
                    updateSelectionCount();
                }, 50);
            } else {
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                checkbox.checked = !bought;
                if (bought) {
                    deleteBtn.style.display = 'none';
                    itemElement.classList.remove('bought');
                } else {
                    deleteBtn.style.display = 'inline-block';
                    itemElement.classList.add('bought');
                }
                const errorText = await response.text();
                console.error('Error response:', response.status, errorText);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ' + response.status);
            }
        } catch (error) {
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
            checkbox.checked = !bought;
            if (bought) {
                deleteBtn.style.display = 'none';
                itemElement.classList.remove('bought');
            } else {
                deleteBtn.style.display = 'inline-block';
                itemElement.classList.add('bought');
            }
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ' + error.message);
        }
    }
    
    async function deleteItem(name) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç "${name}"?`)) {
            return;
        }
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω');
            console.error('CSRF token not found');
            return;
        }
        
        try {
            const response = await fetch(`/api/delete/${encodeURIComponent(name)}?category=${encodeURIComponent(currentCategory)}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            if (response.ok) {
                window.location.reload();
            } else {
                const errorText = await response.text();
                console.error('Error response:', response.status, errorText);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ' + response.status);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ' + error.message);
        }
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–ø–∏—Å–∫–∞ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
    function toggleAddCategory() {
        const form = document.getElementById('addCategoryForm');
        if (form.style.display === 'none') {
            form.style.display = 'flex';
            document.getElementById('newCategoryName').focus();
        } else {
            form.style.display = 'none';
        }
    }
    
    async function addNewCategory() {
        const name = document.getElementById('newCategoryName').value.trim();
        
        if (!name) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞');
            return;
        }
        
        try {
            const response = await fetch('/api/category/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                credentials: 'include',
                body: JSON.stringify({name: name.toLowerCase(), display_name: name})
            });
            
            if (response.ok) {
                document.getElementById('newCategoryName').value = '';
                document.getElementById('addCategoryForm').style.display = 'none';
                window.location.reload();
            } else {
                const data = await response.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞');
        }
    }
    
    async function deleteCategory(categoryName, categoryDisplayName) {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫ "${categoryDisplayName}"?\n\n–í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –±—É–¥—É—Ç —Ç–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω—ã.`)) {
            return;
        }
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω');
            return;
        }
        
        try {
            const response = await fetch(`/api/category/delete/${encodeURIComponent(categoryName)}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                alert(data.message || '–°–ø–∏—Å–æ–∫ —É–¥–∞–ª–µ–Ω');
                // –ï—Å–ª–∏ —É–¥–∞–ª—è–ª–∏ —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                if (currentCategory === categoryName) {
                    window.location.href = '/';
                } else {
                    window.location.reload();
                }
            } else {
                const data = await response.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞: ' + error.message);
        }
    }
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    let selectedItemsList = [];
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É–µ–º —á–µ–∫–±–æ–∫—Å—ã "–∫—É–ø–ª–µ–Ω–æ")
    function updateSelectionCount() {
        try {
            // –ò—â–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã —Å –∫–ª–∞—Å—Å–æ–º checkbox
            const allCheckboxes = document.querySelectorAll('input.checkbox[type="checkbox"]');
            const checkedCheckboxes = document.querySelectorAll('input.checkbox[type="checkbox"]:checked');
            
            console.log('[updateSelectionCount] All checkboxes:', allCheckboxes.length);
            console.log('[updateSelectionCount] Checked checkboxes:', checkedCheckboxes.length);
            
            selectedItemsList = [];
            
            checkedCheckboxes.forEach(cb => {
                const itemElement = cb.closest('.shopping-item');
                if (itemElement) {
                    const itemName = itemElement.getAttribute('data-item-name');
                    if (itemName) {
                        selectedItemsList.push(itemName);
                        console.log('[updateSelectionCount] Found item:', itemName);
                    } else {
                        // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ data-item-name —á–µ–∫–±–æ–∫—Å–∞
                        const checkboxItemName = cb.getAttribute('data-item-name');
                        if (checkboxItemName) {
                            selectedItemsList.push(checkboxItemName);
                            console.log('[updateSelectionCount] Found item from checkbox:', checkboxItemName);
                        } else {
                            console.warn('[updateSelectionCount] Item element found but no data-item-name');
                        }
                    }
                } else {
                    console.warn('[updateSelectionCount] Checkbox found but no shopping-item parent');
                }
            });
            
            const count = selectedItemsList.length;
            const container = document.getElementById('bulkDeleteContainer');
            const countSpan = document.getElementById('selectedCount');
            
            console.log('[updateSelectionCount] Count:', count, 'items:', selectedItemsList);
            console.log('[updateSelectionCount] Container found:', container !== null);
            
            if (!container) {
                console.error('[updateSelectionCount] bulkDeleteContainer not found!');
                return;
            }
            
            if (!countSpan) {
                console.error('[updateSelectionCount] selectedCount span not found!');
                return;
            }
            
            if (count >= 2) {
                container.style.display = 'flex';
                countSpan.textContent = count;
                console.log('[updateSelectionCount] ‚úì Showing bulk delete container with', count, 'items');
            } else {
                container.style.display = 'none';
                console.log('[updateSelectionCount] Hiding bulk delete container (count:', count, ')');
            }
        } catch (error) {
            console.error('[updateSelectionCount] Error:', error);
        }
    }
    
    async function deleteSelectedItems() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const selectedItems = [...selectedItemsList];
        
        console.log('Delete selected items:', selectedItems);
        console.log('Selected count:', selectedItems.length);
        
        if (selectedItems.length < 2) {
            alert(`–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è. –°–µ–π—á–∞—Å –≤—ã–±—Ä–∞–Ω–æ: ${selectedItems.length}`);
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            updateSelectionCount();
            return;
        }
        
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedItems.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤?`)) {
            return;
        }
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω');
            return;
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        let successCount = 0;
        let errorCount = 0;
        const errors = [];
        
        for (const itemName of selectedItems) {
            try {
                const response = await fetch(`/api/delete/${encodeURIComponent(itemName)}?category=${encodeURIComponent(currentCategory)}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    successCount++;
                } else {
                    errorCount++;
                    const errorText = await response.text();
                    errors.push(`${itemName}: ${response.status} ${errorText}`);
                    console.error(`Error deleting ${itemName}:`, response.status, errorText);
                }
            } catch (error) {
                errorCount++;
                errors.push(`${itemName}: ${error.message}`);
                console.error('Error deleting item:', itemName, error);
            }
        }
        
        if (successCount > 0) {
            if (errorCount > 0) {
                alert(`–£–¥–∞–ª–µ–Ω–æ ${successCount} —ç–ª–µ–º–µ–Ω—Ç–æ–≤. –û—à–∏–±–æ–∫: ${errorCount}\n${errors.join('\n')}`);
            }
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
            selectedItemsList = [];
            window.location.reload();
        } else {
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:\n${errors.join('\n')}`);
        }
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–æ–≤ "–∫—É–ø–ª–µ–Ω–æ"
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(function() {
            updateSelectionCount();
        }, 100);
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö DOM
        const observer = new MutationObserver(function(mutations) {
            updateSelectionCount();
        });
        
        const shoppingList = document.getElementById('shoppingList');
        if (shoppingList) {
            observer.observe(shoppingList, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
        }
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ª—é–±–æ–π —á–µ–∫–±–æ–∫—Å (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ onchange –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('checkbox')) {
                setTimeout(function() {
                    updateSelectionCount();
                }, 50);
            }
        });
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        initItemEditing();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–ª—è —É–∂–µ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        document.querySelectorAll('.shopping-item.bought').forEach(item => {
            addMoveButtons(item);
        });
    });
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function initItemEditing() {
        const items = document.querySelectorAll('.shopping-item');
        
        items.forEach(item => {
            const itemName = item.querySelector('.item-name');
            if (itemName) {
                itemName.addEventListener('click', function(e) {
                    // –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –±—ã–ª drag
                    if (isDragging || (Date.now() - dragStartTime < 200)) {
                        return;
                    }
                    
                    const name = item.getAttribute('data-name');
                    const category = item.getAttribute('data-category');
                    const priority = parseInt(item.getAttribute('data-priority')) || 2;
                    
                    editItem(name, category, priority);
                });
            }
        });
    }
    
    function editItem(name, category, priority) {
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const addForm = document.querySelector('.add-form');
        if (addForm) {
            addForm.style.display = 'none';
        }
        const editForm = document.getElementById('editForm');
        if (editForm) {
            editForm.style.display = 'block';
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞
        const nameInput = document.getElementById('editItemName');
        const categorySelect = document.getElementById('editItemCategory');
        const prioritySelect = document.getElementById('editItemPriority');
        
        if (nameInput) nameInput.value = name;
        if (categorySelect) categorySelect.value = category;
        if (prioritySelect) prioritySelect.value = priority;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        editingItemName = name;
        editingItemCategory = category;
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        if (nameInput) {
            nameInput.focus();
            nameInput.select();
        }
    }
    
    async function saveEditItem() {
        const newName = document.getElementById('editItemName').value.trim();
        const newCategory = document.getElementById('editItemCategory').value;
        const newPriority = parseInt(document.getElementById('editItemPriority').value);
        
        if (!newName) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞');
            return;
        }
        
        if (!editingItemName || !editingItemCategory) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç');
            return;
        }
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å CSRF —Ç–æ–∫–µ–Ω');
            return;
        }
        
        try {
            const response = await fetch(`/api/edit/${encodeURIComponent(editingItemName)}?oldCategory=${encodeURIComponent(editingItemCategory)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'include',
                body: JSON.stringify({
                    name: newName,
                    category: newCategory,
                    priority: newPriority
                })
            });
            
            if (response.ok) {
                // –ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
                if (newCategory !== editingItemCategory) {
                    window.location.href = `/?category=${encodeURIComponent(newCategory)}`;
                } else {
                    window.location.reload();
                }
            } else {
                const data = await response.json();
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–∞: ' + error.message);
        }
    }
    
    function cancelEdit() {
        document.getElementById('editForm').style.display = 'none';
        document.querySelector('.add-form').style.display = 'block';
        editingItemName = null;
        editingItemCategory = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑
    async function moveItem(itemName, direction) {
        const items = Array.from(document.querySelectorAll('.shopping-item'));
        const currentIndex = items.findIndex(item => item.getAttribute('data-name') === itemName);
        
        if (currentIndex === -1) {
            console.error('Item not found:', itemName);
            return;
        }
        
        let newIndex;
        if (direction === 'up') {
            if (currentIndex === 0) return; // –£–∂–µ –≤–≤–µ—Ä—Ö—É
            newIndex = currentIndex - 1;
        } else {
            if (currentIndex === items.length - 1) return; // –£–∂–µ –≤–Ω–∏–∑—É
            newIndex = currentIndex + 1;
        }
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ DOM
        const itemElement = items[currentIndex];
        const targetElement = items[newIndex];
        
        if (direction === 'up') {
            itemElement.parentNode.insertBefore(itemElement, targetElement);
        } else {
            itemElement.parentNode.insertBefore(itemElement, targetElement.nextSibling);
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        await saveItemOrder();
    }
    
    async function saveItemOrder() {
        const items = Array.from(document.querySelectorAll('.shopping-item'));
        const itemsData = items.map((item, index) => ({
            name: item.getAttribute('data-name'),
            category: item.getAttribute('data-category')
        }));
        
        const csrfToken = getCSRFToken();
        if (!csrfToken) {
            console.error('CSRF token not found');
            return;
        }
        
        try {
            const response = await fetch('/api/reorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'include',
                body: JSON.stringify(itemsData)
            });
            
            if (!response.ok) {
                console.error('Error saving order:', response.status);
                // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
                window.location.reload();
            }
        } catch (error) {
            console.error('Error saving order:', error);
            // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
            window.location.reload();
        }
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
    document.addEventListener('click', function(event) {
        const categoryNav = document.querySelector('.category-nav');
        const addCategoryForm = document.getElementById('addCategoryForm');
        if (categoryNav && addCategoryForm && !categoryNav.contains(event.target)) {
            addCategoryForm.style.display = 'none';
        }
    });
</script>
{% endblock %}
