# План наведения порядка в проектах Gestalt и Kpalch

## Текущая ситуация

### Проекты:
1. **gestalt** (Go) - оригинальный проект
   - Локально: `/Users/koyash/golang/gestalt-temp`
   - GitHub: https://github.com/Mosl1k/gestalt
   - Статус: есть изменения в `.github/workflows/deploy.yml` и `services/telegram-bot/telegram_bot.py`

2. **kpalch** (Django) - мигрированный проект
   - Локально: `/Users/koyash/Yandex.Disk.localized/gestalt/kpalch.ru`
   - GitHub: https://github.com/Mosl1k/kpalch
   - Статус: много неотслеживаемых файлов, нет миграций для Friendship/SharedList

3. **Сервер** (root@vdska)
   - Папка: `geshtalt`
   - Нужно проверить актуальность версии

## Проблемы

1. ❌ **kpalch**: Нет миграций для моделей Friendship и SharedList (функции друзей и шаринга не работают)
2. ❌ **kpalch**: Много неотслеживаемых файлов в git
3. ❌ **kpalch**: Не синхронизирован с GitHub
4. ❓ **gestalt**: Нужно проверить актуальность версии в GitHub
5. ❓ **Сервер**: Нужно проверить актуальность версии

## План действий

### Этап 1: Проверка и синхронизация gestalt (Go проект) ✅
- [x] Проверить изменения в gestalt-temp
- [x] Закоммитить изменения в gestalt (исправления отступов в telegram_bot.py)
- [x] Убедиться что актуальная рабочая версия с docker-compose в GitHub
- [x] Проверить что сервисы alice и telegram-bot актуальны

### Этап 2: Исправление kpalch (Django проект) ✅
- [x] Создать миграции для Friendship и SharedList моделей
- [x] Проверить что все функции работают (друзья, шаринг, массовое удаление)
- [x] Настроить .gitignore для правильного игнорирования файлов
- [x] Добавить все новые файлы в git
- [x] Закоммитить изменения в kpalch

### Этап 3: Синхронизация с GitHub ✅
- [x] Запушить kpalch в GitHub
- [x] Проверить что версии совпадают

### Этап 4: Проверка сервера ✅
- [x] Подключиться к root@vdska
- [x] Проверить версию в папке geshtalt
- [x] Синхронизировать с GitHub если нужно
- [x] Применить миграции на сервере
- [x] Обновить docker-compose.yaml для использования Django
- [x] Пересобрать контейнеры

### Этап 5: Настройка локального тестирования ✅
- [x] Создать .env файл для локального тестирования
- [x] Запустить Docker Compose локально
- [x] Применить миграции локально
- [x] Проверить что приложение работает

### Этап 6: Умный деплой для kpalch ✅
- [x] Адаптировать smart-deploy.sh из gestalt для kpalch
- [x] Учесть различия (Go vs Django, Redis vs PostgreSQL)
- [x] Добавить автоматическое применение миграций

### Этап 7: Восстановление данных из Redis ⏳
- [ ] Проверить наличие бэкапов Redis на сервере
- [ ] Использовать команду migrate_from_redis для восстановления данных
- [ ] Восстановить данные к аккаунту пользователя
- [ ] Проверить что все данные восстановлены корректно
- **Примечание**: Выполнять в последнюю очередь, когда всё будет работать (с телеграм ботом и алисой)

## Приоритеты

1. **Критично**: Исправить OAuth ошибку "Unknown client with such client_id" (проверить YANDEX_CLIENT_ID на сервере)
2. **Критично**: Создать миграции для Friendship/SharedList (иначе функции не работают) ✅
3. **Важно**: Синхронизировать kpalch с GitHub ✅
4. **Важно**: Проверить и синхронизировать сервер ✅
5. **Желательно**: Настроить локальное тестирование ✅
6. **Желательно**: Умный деплой для kpalch ✅
7. **В последнюю очередь**: Восстановить данные из Redis к аккаунту пользователя (после того как всё заработает)

## Заметки

- Функции друзей, шаринга списков и массового удаления **есть в коде**, но не работают из-за отсутствия миграций
- В gestalt есть умный скрипт деплоя (smart-deploy.sh), который нужно адаптировать для kpalch
- На сервере используется Docker Compose, нужно убедиться что версия актуальна

